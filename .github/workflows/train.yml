name: ML Training Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run training script
      id: train
      run: |
        python train.py | tee training_output.txt
    
    - name: Extract metrics
      id: metrics
      run: |
        MSE=$(grep "MSE:" training_output.txt | awk '{print $2}')
        R2=$(grep "R2 Score:" training_output.txt | awk '{print $3}')
        echo "mse=$MSE" >> $GITHUB_OUTPUT
        echo "r2=$R2" >> $GITHUB_OUTPUT
    
    - name: Generate Job Summary
      run: |
        echo "# ML Training Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Student Name:** Kishan" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Roll Number:** 2022BCS0206" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Evaluation Metrics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **MSE** | ${{ steps.metrics.outputs.mse }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **R2 Score** | ${{ steps.metrics.outputs.r2 }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Run Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload trained model
      uses: actions/upload-artifact@v4
      with:
        name: trained-model-run-${{ github.run_number }}
        path: outputs/model.pkl
    
    - name: Upload results JSON
      uses: actions/upload-artifact@v4
      with:
        name: results-run-${{ github.run_number }}
        path: outputs/results.json
